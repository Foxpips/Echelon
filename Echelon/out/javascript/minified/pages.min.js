$(function(){function n(n,e){var a=$('<div class="info">');e?a.html(n):a.text(n),i.append(a)}function e(n,e){var a=$('<span class="username">').text(n+":");n===l&&a.addClass("me");var s=$('<span class="message">').text(e),o=$('<div class="message-container">');o.append(a).append(s),i.append(o),i.scrollTop(i[0].scrollHeight)}function a(){t.join().then(function(e){n('Joined channel as <span class="me">'+l+"</span>.",!0)}),t.on("messageAdded",function(n){e(n.author,n.body)})}var s,o,t,l,i=$("#messages");n("Logging in..."),$.getJSON("/token",{identity:l,device:"browser"},function(e){l=e.identity,n('You have been assigned a random username of: <span class="me">'+l+"</span>",!0),s=new Twilio.AccessManager(e.token),o=new Twilio.IPMessaging.Client(s),n('Attempting to join "general" chat channel...');var i=o.getChannelByUniqueName("general");i.then(function(n){t=n,t?(console.log("Found general channel:"),console.log(t),a()):o.createChannel({uniqueName:"general",friendlyName:"General Chat Channel"}).then(function(n){console.log("Created general channel:"),console.log(n),t=n,a()})})});var c=$("#chat-input");c.on("keydown",function(n){13===n.keyCode&&(t.sendMessage(c.val()),c.val(""))})});