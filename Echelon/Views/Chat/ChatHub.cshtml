@section metadata{
    <title>Echelon Chat</title>
}

<style>
    .border { border-bottom: solid gray 1px; }

    .smileys { height: 15px; }
</style>


<section id="container" class="form__contianer">
    <input type="hidden" id="displayname"/>
    <div style="height: 80%;">
        <div id="chats" style="float: left; width: 80%;"></div>
        <div id="onlineList" style="border-left: solid red 2px; float: right; height: 100%; width: 19%;">
            <div style="border-bottom: double; font-size: 20px;">Online Users</div>
        </div>
    </div>
    <div style="background-color: lightgray; border-top: double black; height: 19%;">
        <div style="float: left; height: 90%; position: relative; top: 10%;">
            <textarea spellcheck="true" id="message" style="height: 80%; width: 625px;"></textarea>
        </div>
        <div style="float: left; position: relative; top: 30%;">
            <input type="button" id="sendmessage" value="Send"/>
        </div>
        <div style="float: left; position: relative; top: 30%;">
            <select id="users">
                <option value="All">All</option>
            </select>
        </div>
    </div>
</section>

@section scripts {
    <script src="~/Scripts/jquery.signalR-2.2.2.min.js" type="text/javascript"></script>
    <script src="~/signalr/hubs"></script>

    <script type="text/javascript">
        $(function() {

            var chat = $.connection.chatHub;

            // Get the user name.
            $('#displayname').val(prompt('Enter your name:', ''));
            chat.client.differentName = function(name) {
                // Prompts for different user name
                $('#displayname').val(prompt('Please enter different username:', ''));
                chat.server.notify($('#displayname').val(), $.connection.hub.id);
            };

            chat.client.online = function(name) {
                // Update list of users
                if (name == $('#displayname').val())
                    $('#onlineList').append('<div class="border" style="color:red">You: ' + name + '</div>');
                else {
                    $('#onlineList').append('<div class="border">' + name + '</div>');
                    $("#users").append('<option value="' + name + '">' + name + '</option>');
                }
            };

            chat.client.enters = function(name) {
                $('#chats').append('<div class="border"><i>' + name + ' enters chatroom</i></div>');
                $("#users").append('<option value="' + name + '">' + name + '</option>');
                $('#onlineList').append('<div class="border">' + name + '</div>');
            };
            // Create a function that the hub can call to broadcast chat messages.
            chat.client.broadcastMessage = function(name, message) {
                //Interpret smileys
                message = message.replace(":)", "<img src=\"/emoticons/smile.png\" class=\"smileys\" />");
                message = message.replace(";)", "<img src=\"/emoticons/wink.png\" class=\"smileys\" />");
                message = message.replace(":D", "<img src=\"/emoticons/laugh.png\" class=\"smileys\" />");

                //display the message
                $('#chats')
                    .append('<div class="border"><span style="color:blue">' + name + '</span>: ' + message + '</div>');
            };

            chat.client.disconnected = function(name) {
                //Calls when someone leaves the page
                $('#chats').append('<div class="border"><i>' + name + ' leaves chatroom</i></div>');
                $('#onlineList div').remove(":contains('" + name + "')");
                $("#users option").remove(":contains('" + name + "')");
            }

            // Start the connection.
            $.connection.hub.start()
                .done(function() {
                    //Calls the notify method of the server
                    chat.server.notify($('#displayname').val(), $.connection.hub.id);

                    $('#sendmessage')
                        .click(function() {
                            if ($("#users").val() == "All") {
                                // Call the Send method on the hub. 
                                chat.server.send($('#displayname').val(), $('#message').val());
                            } else {
                                chat.server.sendToSpecific($('#displayname').val(),
                                    $('#message').val(),
                                    $("#users").val());
                            }
                            // Clear text box and reset focus for next comment. 
                            $('#message').val('').focus();
                        });

                });
        });
    </script>
}